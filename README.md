# Project Members:
1. Ahmad Saad Khan (akhan7)
2. Diksha Gohlyan (dgohlya)
3. Manasee Joshi (mjoshi2)

# MILESTONE 2

## Setup

1. Clone this repository
	```bash
	git clone https://github.ncsu.edu/akhan7/DevOps-Project.git
	```

2. Navigate to the Milestone 2 folder, and fork the open source project - [Koop](https://github.com/koopjs/koop "Koop's Github repository")
	```bash
	git clone https://github.com/koopjs/koop
	```

2. Run script.sh
	```bash
	./script.sh
	```


## Testing
1. **Test Suite**
	
	All the dependencies for the project are intalled from package.json by using `npm install` included in the _script.sh_ file. We've used Mocha to execute the unit tests. The unit tests were included in the project as _test.js_. We've run Istanbul on the test results to get a coverage report as well as to tabulate the number of test cases passing and failing.

	The code for running the unit test cases and running Istanbul on them:
	```bash
	node_modules/.bin/istanbul cover node_modules/.bin/_mocha -- --recursive > TestResult
	```
	Here is a screenshot of the TestResult file being generated by Istanbul:
	[![TestResult](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screenshots/TestResult.jpg)](#TestResult)

2. **Advanced Testing (Test Case Generation)**
	
	The advanced testing technique employed is test case generation. The _main.js_ file is used to generate the test cases. The file which is being used to generate the test cases is _Query.js_ which is a file in koop/lib/ folder. The generated test cases are stored in _test.js_ file. We run Istanbul on the test.js file and save the results in AutomatedTestResult file to get the code coverage of the project using our generated test cases (this will be very less as we are generating very less number of test cases automatically). 

	Code for generating automatic test cases:
	```bash
	node main.js lib/Query.js
	node_modules/.bin/istanbul cover test.js > AutomatedTestResult
	```

	Here is a screenshot of test.js file containing the automatic test cases generated:
	[![test.js](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screenshots/test.jpg)](#test.js)

	Here is a screenshot of test.js file containing the automatic test cases generated:
	[![AutomaticTestResult.js](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screenshots/AutomaticTestResult.jpg)](#AutomaticTestResult.js)


## Analysis
1. **Static Analysis**

	JSHint is the tool used for static analysis. JSHint is a tool that helps detect errors and potential problems in Javascript code. This tool is being used on all the javascript files in the koop folder to find the errors in the code. The log of all the bugs found are being stored in a file FoundBugs. 

	Code for running jshint and storing in FoundBugs:
	```bash
	node_modules/.bin/jshint *.js > FoundBugs
	```  

	Here is a screenshot of the bugs found by using JSHint.
	[![FoundBugs](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screenshots/FoundBugs.jpg)](#FoundBugs)


2. **Custom Metrics**
	
	To get a custom metric analysis, we've written custom.js. This evaluates the following conditions:
	* Max condition: Counts the max number of conditions within an if statement in a function.
	* Long method: Detects a long method, i.e. a method with greater than 30 lines of code.
	* Free-style: Detects how many parameters are being passed in a method. If more than 3 parameters are being passed in a method, it raises an error.

	The results of custom.js are being stored in CustomMetrics. The screenshot for CustomMetrics is below:
	[![CustomMetrics](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screenshots/CustomMetrics.jpg)](#CustomMetrics)

### Git Hook

We are using a pre-commit hook to ensure that any commit being made meets a certain testing and analysis criteria. A script is passed to the pre-commit hook in the koop/.git/hooks folder. If this script exits with a code of 0, the commit is allowed to be made to the local copy of the koop folder. If the exit code is 1 or greater, the commit command is aborted. 

The testing criteria we have chosen to implement is that even if a single test case fails, or if the code coverage is less than 50%, fail the commit. To check if a test case failed, the pre-commit script checks the file TestResults (which stores the results of the all the test cases we ran using mocha). If there is any test case which is found to fail, exit the script with code 1. To check the coverage, store the coverage value generated by Istanbul in a variable, and check this against a threshold of 50. If the value is less than 50, exit with a code 1. This prevents the commit from being made.

The analysis criteria we have implemented is that if JSHint finds any error in any of the code, do not allow the commit to be made. To do this, store the log generated by JSHint in a file FoundBugs. The script in pre-commit parses through this file and exits with code 1 if there were any errors found in the code. This aborts the commit command.

If all these statements are false, that is if all the test cases are passing, the code coverage is more than 50% and there are no errors found, then the script exits with code 0 and a commit is allowed to be made.

Here is a screenshot of the pre-commit hook:
[![Pre-CommitHook](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screenshots/Pre-CommitHook.jpg)](#Pre-CommitHook)



## Screencast
1. GIF of commit failing due to a failed testcase:
[![1.gif](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screencast/1.gif)](#1.gif)

2. GIF of commit failing due to less code coverage:
[![2.gif](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screencast/2.gif)](#2.gif)

3. GIF of a commit failing due to errors in code:
[![3.gif](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screencast/3.gif)](#3.gif)

4. GIF of a commit passing when all testing and analysis conditions are met:
[![4.gif](https://github.ncsu.edu/akhan7/DevOps-Project/blob/master/Milestone%202/Screencast/4.gif)](#4.gif)

